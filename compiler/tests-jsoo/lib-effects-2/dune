(env
 (_
  (flags
   (:standard -w -38))
  (js_of_ocaml
   (flags
    (:standard --effects=double-translation))
   ;; separate compilation doesn't yet work when using
   ;; '--effect=double-translation' since Dune doesn't know it should compile a
   ;; different version of the dependencies.
   ;; TODO: remove once support in ocaml/dune#11222 is released.
   (compilation_mode whole_program))))

(copy_files#
 (only_sources true)
 (files ../lib-effects/*.ml))

(copy_files
 (only_sources true)
 (files ../lib-effects/*.expected))

(library
 (name jsoo_testsuite_effect2)
 (enabled_if
  (>= %{ocaml_version} 5))
 (inline_tests
  (modes js))
 (modules
  (:standard
   \
   assume_no_perform
   assume_no_perform_unhandled
   assume_no_perform_nested_handler
   deep_state
   effects))
 (preprocess
  (pps ppx_expect)))

(tests
 (build_if
  (>= %{ocaml_version} 5))
 (names effects)
 (modules effects)
 (modes js))

(tests
 (build_if
  (>= %{ocaml_version} 5))
 (names
  assume_no_perform
  assume_no_perform_unhandled
  assume_no_perform_nested_handler)
 (modules
  assume_no_perform
  assume_no_perform_unhandled
  assume_no_perform_nested_handler)
 (libraries js_of_ocaml)
 (action
  (ignore-outputs
   (with-accepted-exit-codes
    0
    (run node %{test}))))
 (modes js))
