(executable
 (name effects_flags)
 (modules effects_flags))

(rule
 (target effects_flags.txt)
 (action
  (with-stdout-to
   %{target}
   (run ./effects_flags.exe %{profile}))))

(executable
 (name main)
 (modules main)
 (libraries wasm_of_ocaml-compiler.dynlink)
 (link_flags
  (:standard -linkall))
 (modes wasm)
 (wasm_of_ocaml
  (compilation_mode separate)))

(rule
 (target plugin.cmo)
 (action
  (run %{bin:ocamlc} -c %{dep:./plugin.ml})))

(rule
 (target plugin.wasmo)
 (enabled_if %{env:WASM_OF_OCAML=false})
 (action
  (run
   %{bin:wasm_of_ocaml}
   compile
   %{read-strings:effects_flags.txt}
   %{dep:plugin.cmo}
   -o
   %{target})))

(rule
 (target main.out)
 (deps plugin.wasmo)
 (enabled_if %{env:WASM_OF_OCAML=false})
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./main.bc.wasm.js}))))

(rule
 (alias runtest-wasm)
 (enabled_if %{env:WASM_OF_OCAML=false})
 (action
  (diff main.out.expected main.out)))

(executable
 (name compile_plugin)
 (modules compile_plugin)
 (libraries wasm_of_ocaml-compiler js_of_ocaml-compiler))

(rule
 (target plugin_compiled.wasmo)
 (deps plugin.cmo)
 (action
  (run ./compile_plugin.exe %{read-strings:effects_flags.txt})))

(executable
 (name main_compile_and_load)
 (modules main_compile_and_load)
 (libraries wasm_of_ocaml-compiler.dynlink)
 (link_flags
  (:standard -linkall))
 (modes wasm)
 (wasm_of_ocaml
  (compilation_mode separate)))

(rule
 (target main_compile_and_load.out)
 (deps plugin_compiled.wasmo)
 (enabled_if %{env:WASM_OF_OCAML=false})
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./main_compile_and_load.bc.wasm.js}))))

(rule
 (alias runtest-wasm)
 (enabled_if %{env:WASM_OF_OCAML=false})
 (action
  (diff main_compile_and_load.out.expected main_compile_and_load.out)))
