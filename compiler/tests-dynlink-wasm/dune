(executable
 (name main)
 (modules main)
 (libraries wasm_of_ocaml-compiler.dynlink)
 (link_flags
  (:standard -linkall))
 (modes wasm)
 (wasm_of_ocaml
  (compilation_mode separate)))

(rule
 (target plugin.cmo)
 (action
  (run %{bin:ocamlc} -c %{dep:./plugin.ml})))

(rule
 (target plugin2.cma)
 (action
  (run
   %{bin:ocamlc}
   -a
   %{dep:./plugin2a.ml}
   %{dep:./plugin2b.ml}
   -o
   plugin2.cma)))

(rule
 (target plugin_js.cmo)
 (action
  (run %{bin:ocamlc} -c %{dep:./plugin_js.ml})))

(rule
 (target plugin.wasmo)
 (action
  (run %{bin:wasm_of_ocaml} compile %{dep:plugin.cmo} -o %{target})))

(rule
 (target main.out)
 (deps plugin.wasmo)
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./main.bc.wasm.js}))))

(rule
 (alias runtest-wasm)
 (action
  (diff main.out.expected main.out)))

(executable
 (name compile_plugin)
 (modules compile_plugin)
 (libraries wasm_of_ocaml-compiler js_of_ocaml-compiler))

(rule
 (target plugin_compiled.wasmo)
 (deps plugin.cmo)
 (action
  (run ./compile_plugin.exe)))

(executable
 (name main_compile_and_load)
 (modules main_compile_and_load)
 (libraries wasm_of_ocaml-compiler.dynlink)
 (link_flags
  (:standard -linkall))
 (modes wasm)
 (wasm_of_ocaml
  (compilation_mode separate)))

(rule
 (target main_compile_and_load.out)
 (deps plugin_compiled.wasmo)
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./main_compile_and_load.bc.wasm.js}))))

(rule
 (alias runtest-wasm)
 (action
  (diff main_compile_and_load.out.expected main_compile_and_load.out)))

(executable
 (name dynlink_loadfile)
 (modules dynlink_loadfile)
 (libraries dynlink wasm_of_ocaml-compiler.dynlink)
 (link_flags
  (:standard -linkall))
 (modes wasm)
 (wasm_of_ocaml
  (compilation_mode separate)))

(rule
 (target dynlink_loadfile.out)
 (deps plugin.cmo plugin2.cma)
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./dynlink_loadfile.bc.wasm.js}))))

(rule
 (alias runtest-wasm)
 (action
  (diff dynlink_loadfile.out.expected dynlink_loadfile.out)))

(executable
 (name dynlink_loadfile_wp)
 (modules dynlink_loadfile_wp)
 (libraries
  dynlink
  wasm_of_ocaml-compiler.dynlink
  js_of_ocaml-compiler.runtime)
 (link_flags
  (:standard -linkall))
 (modes byte))

(rule
 (targets
  dynlink_loadfile_wp.js
  (dir dynlink_loadfile_wp.assets))
 (action
  (run
   %{bin:wasm_of_ocaml}
   compile
   --dynlink
   %{dep:dynlink_loadfile_wp.bc}
   -o
   dynlink_loadfile_wp.js)))

(rule
 (target dynlink_loadfile_wp.out)
 (deps
  plugin.cmo
  plugin2.cma
  plugin_js.cmo)
 (action
  (with-outputs-to
   %{target}
   (run %{bin:node} %{dep:./dynlink_loadfile_wp.js}))))

(rule
 (alias runtest-wasm)
 (action
  (diff dynlink_loadfile_wp.out.expected dynlink_loadfile_wp.out)))
