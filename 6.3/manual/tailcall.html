<html><head><title> Tail call optimization</title><meta charset="utf8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link rel="stylesheet" href="https://ocsigen.org/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script type="application/javascript" src="https://ocsigen.org/js/client.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js">
//<![CDATA[

//]]>
</script><script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js">
//<![CDATA[

//]]>
</script></head><body class="tailcall js_of_ocaml"><div class="project-page"><div class="page-header"><p class="logo-ocsigen"><a href=".././../../" class="ocsimore_phrasing_link"><img src=".././../../img/ocsigen-white.svg" alt="Ocsigen"/></a>
</p><p class="logo-subproject">Js_of_ocaml</p><div class="mainmenu"><p class="mainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a></p><p class="mainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a></p><p><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a></p><p class="mainmenu-current"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a></p><p><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a></p><p><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a></p><p><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a></p><p><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a></p></div><form id="googlesearch" action="https://google.com/search"><input name="q" id="gsearch-box" placeholder="Search using Google"/><label for="gsearch-box"><img src="/img/search.svg" alt="" id="gsearch-icon"/></label><input type="submit" id="gsearch-submit" onclick="document.getElementById('gsearch-box').value += ' site:ocsigen.org';"/></form><aside class="how-drawer"><input id="how-drawer-toggle" type="checkbox"/><label for="how-drawer-toggle" id="how-drawer-label"><span class="how-drawer-icon"></span></label><nav class="how-drawer-content"><ul class="drawermainmenu"><li class="drawermainmenu-home"><a href=".././../../" class="ocsimore_phrasing_link">Home</a>
</li><li class="drawermainmenu-doc"><a href=".././../../tuto/" class="ocsimore_phrasing_link">Doc</a>
</li><li class="drawermainmenu-project"><a href=".././../../eliom/" class="ocsimore_phrasing_link">Eliom</a>
</li><li class="drawermainmenu-project"><a href=".././../../js_of_ocaml/" class="ocsimore_phrasing_link">Js_of_ocaml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigenserver/" class="ocsimore_phrasing_link">Server</a>
</li><li class="drawermainmenu-project"><a href=".././../../lwt/" class="ocsimore_phrasing_link">Lwt</a>
</li><li class="drawermainmenu-project"><a href=".././../../tyxml/" class="ocsimore_phrasing_link">Tyxml</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-toolkit/" class="ocsimore_phrasing_link">Toolkit</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsigen-start/" class="ocsimore_phrasing_link">Start</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsipersist/" class="ocsimore_phrasing_link">Ocsipersist</a>
</li><li class="drawermainmenu-project"><a href=".././../../html_of_wiki/" class="ocsimore_phrasing_link">html_of_wiki</a>
</li><li class="drawermainmenu-project"><a href=".././../../ocsimore/" class="ocsimore_phrasing_link">Ocsimore (<em>deprecated</em>)</a>
</li><li class="drawermainmenu-page"><a href=".././../../projects" class="ocsimore_phrasing_link">Other projects</a>
</li><li class="drawermainmenu-page"><a href=".././../../papers" class="ocsimore_phrasing_link">Research papers</a>
</li><li class="drawermainmenu-page"><a href=".././../../credits" class="ocsimore_phrasing_link">Who does Ocsigen?</a>
</li><li class="drawermainmenu-page"><a href=".././../../contributing" class="ocsimore_phrasing_link">Contributing</a>
</li><li class="drawermainmenu-page"><a href=".././../../blog" class="ocsimore_phrasing_link">Blog</a>
</li><li class="drawermainmenu-page"><a href=".././../../install" class="ocsimore_phrasing_link">Installation</a>
</li><li class="drawermainmenu-page"><a href="https://github.com/ocsigen" class="ocsimore_phrasing_link">Source code</a>
</li></ul><nav class="how-doctree"><h2>Getting Started</h2><h3><a href="overview" class="ocsimore_phrasing_link">Overview</a></h3><h3><a href="install" class="ocsimore_phrasing_link">Installation</a></h3><h3><a href="quickstart" class="ocsimore_phrasing_link">Quick Start</a></h3><h2>Programming Guide</h2><h3><a href="javascript-interop" class="ocsimore_phrasing_link">JavaScript interop</a></h3><h3><a href="ppx" class="ocsimore_phrasing_link">PPX syntax extension</a></h3><h3><a href="ppx-deriving" class="ocsimore_phrasing_link">JSON derivation</a></h3><h3><a href="rev-bindings" class="ocsimore_phrasing_link">Export OCaml code to JavaScript</a></h3><h3><a href="errors" class="ocsimore_phrasing_link">Error handling</a></h3><h3><span><a href=".././api/js_of_ocaml/">API</a></span></h3><h2>Lwt Support</h2><h3><a href="lwt" class="ocsimore_phrasing_link">Lwt support</a></h3><h3><span><a href=".././api/js_of_ocaml-lwt/">API</a></span></h3><h2>Compiler</h2><h3><a href="options" class="ocsimore_phrasing_link">Command line options</a></h3><h3><a href="compilation-modes" class="ocsimore_phrasing_link">Compilation modes</a></h3><h3><a href="linker" class="ocsimore_phrasing_link">JavaScript primitives</a></h3><h3><a href="tailcall" class="ocsimore_phrasing_link">Tailcall optimization</a></h3><h3><a href="effects" class="ocsimore_phrasing_link">Effect handlers</a></h3><h3><a href="runtime-representation" class="ocsimore_phrasing_link">Runtime representation</a></h3><h2>Wasm_of_ocaml</h2><h3><a href="wasm_overview" class="ocsimore_phrasing_link">Overview</a></h3><h3><a href="wasm_runtime" class="ocsimore_phrasing_link">Writing Wasm primitives</a></h3><h2>How-to Guides</h2><h3><a href="build-toplevel" class="ocsimore_phrasing_link">Build a toplevel or use Dynlink</a></h3><h3><a href="debug" class="ocsimore_phrasing_link">Debug a program</a></h3><h3><a href="performances" class="ocsimore_phrasing_link">Performance</a></h3><h3><a href="contribute" class="ocsimore_phrasing_link">Contribute</a></h3><h2>Try it</h2><h3><span><a href=".././manual/files/toplevel/index.html">OCaml toplevel</a></span></h3><h3><a href="examples" class="ocsimore_phrasing_link">Examples and projects</a></h3></nav></nav></aside></div><p class="reasonwarning">Warning: Reason support is experimental.
We are looking for beta-tester and contributors.
</p><button id="reason">Switch to </button><div class="twocols"><nav class="leftcol">Version <select class="how-versions" onchange="location = this.value;"><option value=".././../dev/manual/tailcall">dev</option><option value=".././../6.3/manual/tailcall" selected="selected">6.3</option><option value=".././../6.2.0/manual/tailcall">6.2.0</option><option value=".././../6.1.0/manual/tailcall">6.1.0</option><option value=".././../6.0.1/manual/tailcall">6.0.1</option><option value=".././../5.9.1/manual/tailcall">5.9.1</option><option value=".././../5.8.2/manual/tailcall">5.8.2</option><option value=".././../5.7.2/manual/tailcall">5.7.2</option><option value=".././../5.6.0/manual/tailcall">5.6.0</option><option value=".././../5.5.2/manual/tailcall">5.5.2</option><option value=".././../5.4.0/manual/tailcall">5.4.0</option><option value=".././../5.3.0/manual/tailcall">5.3.0</option><option value=".././../5.2.0/manual/tailcall">5.2.0</option><option value=".././../5.1.0/manual/tailcall">5.1.0</option><option value=".././../5.0.1/manual/tailcall">5.0.1</option><option value=".././../4.1.0/manual/tailcall">4.1.0</option><option value=".././../4.0.0/manual/tailcall">4.0.0</option><option value=".././../3.11.0/manual/tailcall">3.11.0</option><option value=".././../3.10.0/manual/tailcall">3.10.0</option><option value=".././../3.9.0/manual/tailcall">3.9.0</option><option value=".././../3.8.0/manual/tailcall">3.8.0</option><option value=".././../3.7.0/manual/tailcall">3.7.0</option><option value=".././../3.6.0/manual/tailcall">3.6.0</option><option value=".././../3.5.1/manual/tailcall">3.5.1</option></select><nav class="how-doctree"><h2>Getting Started</h2><h3><a href="overview" class="ocsimore_phrasing_link">Overview</a></h3><h3><a href="install" class="ocsimore_phrasing_link">Installation</a></h3><h3><a href="quickstart" class="ocsimore_phrasing_link">Quick Start</a></h3><h2>Programming Guide</h2><h3><a href="javascript-interop" class="ocsimore_phrasing_link">JavaScript interop</a></h3><h3><a href="ppx" class="ocsimore_phrasing_link">PPX syntax extension</a></h3><h3><a href="ppx-deriving" class="ocsimore_phrasing_link">JSON derivation</a></h3><h3><a href="rev-bindings" class="ocsimore_phrasing_link">Export OCaml code to JavaScript</a></h3><h3><a href="errors" class="ocsimore_phrasing_link">Error handling</a></h3><h3><span><a href=".././api/js_of_ocaml/">API</a></span></h3><h2>Lwt Support</h2><h3><a href="lwt" class="ocsimore_phrasing_link">Lwt support</a></h3><h3><span><a href=".././api/js_of_ocaml-lwt/">API</a></span></h3><h2>Compiler</h2><h3><a href="options" class="ocsimore_phrasing_link">Command line options</a></h3><h3><a href="compilation-modes" class="ocsimore_phrasing_link">Compilation modes</a></h3><h3><a href="linker" class="ocsimore_phrasing_link">JavaScript primitives</a></h3><h3><a href="tailcall" class="ocsimore_phrasing_link">Tailcall optimization</a></h3><h3><a href="effects" class="ocsimore_phrasing_link">Effect handlers</a></h3><h3><a href="runtime-representation" class="ocsimore_phrasing_link">Runtime representation</a></h3><h2>Wasm_of_ocaml</h2><h3><a href="wasm_overview" class="ocsimore_phrasing_link">Overview</a></h3><h3><a href="wasm_runtime" class="ocsimore_phrasing_link">Writing Wasm primitives</a></h3><h2>How-to Guides</h2><h3><a href="build-toplevel" class="ocsimore_phrasing_link">Build a toplevel or use Dynlink</a></h3><h3><a href="debug" class="ocsimore_phrasing_link">Debug a program</a></h3><h3><a href="performances" class="ocsimore_phrasing_link">Performance</a></h3><h3><a href="contribute" class="ocsimore_phrasing_link">Contribute</a></h3><h2>Try it</h2><h3><span><a href=".././manual/files/toplevel/index.html">OCaml toplevel</a></span></h3><h3><a href="examples" class="ocsimore_phrasing_link">Examples and projects</a></h3></nav></nav><article class="rightcol"><h1> Tail call optimization</h1><p>Tail call optimization (TCO) support in JavaScript depends on the VM. JavaScriptCore
(Safari, Bun) implements TCO, but V8 (Chrome, Node.js) and SpiderMonkey (Firefox)
do not. To ensure portable stack safety, js_of_ocaml optimizes common tail call patterns.
</p><h2 id="summary"> What gets optimized <a class="backref" href="#summary">&#182;</a></h2><table><tr><th> Pattern </th><th> Optimization </th></tr><tr><td> Self-recursive tail calls </td><td> Compiled to a loop </td></tr><tr><td> Mutually recursive tail calls </td><td> Compiled with a trampoline </td></tr><tr><td> Other tail calls </td><td> Not optimized (may overflow) </td></tr></table><p>To optimize other tail calls, try <span class="teletype">--effects=cps</span> or <span class="teletype">--effects=double-translation</span>.
This partially transforms the code to continuation-passing style, but has a performance cost.
See <span><a href=".././manual/effects">effect handlers</a></span>.
</p><h2 id="self-recursive"> Self-recursive functions <a class="backref" href="#self-recursive">&#182;</a></h2><p>Self-recursive tail calls are compiled into loops:
</p><pre class=""><code class="language-ocaml translatable">let rec fact x acc =
  if x = 0
  then acc
  else fact (pred x) (acc * x)</code></pre><p>Generated JavaScript:
</p><pre class="manually-translated"><code class="language-javascript">function fact(x$1, acc$1){
  var x = x$1, acc = acc$1;
  for(;;){
    if(0 === x) return acc;
    var acc$0 = runtime.caml_mul(acc, x), x$0 = x - 1 | 0;
    x = x$0;
    acc = acc$0;
  }
}</code></pre><h2 id="mutual-recursive"> Mutually recursive functions <a class="backref" href="#mutual-recursive">&#182;</a></h2><p>Mutually recursive functions use a trampoline—a loop that catches returned
continuations and re-invokes them, avoiding deep call stacks:
</p><pre class=""><code class="language-ocaml translatable">let rec even n =
  match n with
  | 0 -&gt; true
  | x -&gt; odd (x - 1)
and odd n =
  match n with
  | 0 -&gt; false
  | x -&gt; even (x - 1)</code></pre><p>Generated JavaScript:
</p><pre class="manually-translated"><code class="language-javascript">function even$0(counter, n){
  if(0 === n) return 1;
  var a = n - 1 | 0;
  if(counter &gt;= 50) return caml_trampoline_return(odd$0, [0, a]);
  var counter$0 = counter + 1 | 0;
  return odd$0(counter$0, a);
}
function even(n){return caml_trampoline(even$0(0, n));}
function odd$0(counter, n){
  if(0 === n) return 0;
  var a = n - 1 | 0;
  if(counter &gt;= 50) return caml_trampoline_return(even$0, [0, a]);
  var counter$0 = counter + 1 | 0;
  return even$0(counter$0, a);
}
function odd(n){return caml_trampoline(odd$0(0, n));}</code></pre><p><strong>Note</strong>: The generated code doesn't return to the trampoline on every call (controlled
by the <span class="teletype">tc_depth</span> parameter, default 50). This balances stack safety with performance.
</p><h2 id="not-optimized"> Patterns not optimized <a class="backref" href="#not-optimized">&#182;</a></h2><p>These patterns are <strong>not</strong> optimized and may cause stack overflows with deep recursion:
</p><p><strong>Tail call through a local function:</strong>
</p><pre class=""><code class="language-ocaml translatable">let rec f x =
  let g delta = f (x - delta) in
  if x &lt; 0 then 0
  else if x mod 2 = 0 then g 2
  else g 1</code></pre><p><strong>Tail call to a function argument:</strong>
</p><pre class=""><code class="language-ocaml translatable">let bind x f =
  match x with
  | None -&gt; None
  | Some x -&gt; f x  (* f is unknown, can't optimize *)</code></pre><p>For these patterns, you can try <span class="teletype">--effects=cps</span>.
</p><h2 id="tuning"> Tuning <a class="backref" href="#tuning">&#182;</a></h2><p>The trampoline depth can be adjusted with <span class="teletype">--set tc_depth=N</span> (default: 50).
Higher values improve performance but increase stack usage.
</p><h2> See also</h2><ul><li> <span><a href=".././manual/effects">Effect handlers</a></span> — Full tail call optimization with CPS
</li><li> <span><a href=".././manual/options">Command-line options</a></span> — The <span class="teletype">tc_depth</span> parameter</li></ul></article></div></div></body></html>
