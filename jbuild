(* -*- tuareg -*- *)
#require "unix"
let git_version =
  if not (try Sys.is_directory ".git" with _ -> false)
  then ""
  else
    let ic = Unix.open_process_in "git log -n1 --pretty=format:%h" in
    let version = input_line ic in
    close_in ic;
    version

let () = Printf.ksprintf Jbuild_plugin.V1.send {|
(rule
 ((targets (git_version.ml.in))
  (deps ())
  (action (with-stdout-to ${@}
           (echo "let git_version = \"%s\"")))))
|} git_version
